<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileZila - The Ultimate File Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .drop-zone {
            border: 2px dashed #3b82f6;
            transition: background-color 0.2s ease-in-out;
        }
        .drop-zone--over {
            background-color: #3b82f620;
        }
        .drop-zone__input {
            display: none;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar {
            height: 1rem;
            background-color: #3b82f6;
            width: 0%;
            transition: width 0.3s ease-in-out;
            border-radius: 9999px;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 antialiased">

    <div id="converter-page" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M8 3L4 7l4 4"/><path d="M4 7h16"/><path d="M16 21l4-4-4-4"/><path d="M20 17H4"/></svg>
                        <span class="ml-2 text-xl font-bold text-gray-900 dark:text-white">FileZila</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="py-8 sm:py-10">
            <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
                <!-- Uploader Section -->
                <section id="uploader-section" class="text-center">
                    <h1 class="text-4xl font-extrabold text-gray-900 dark:text-white sm:text-5xl md:text-6xl">Convert Your Files</h1>
                    <p class="mt-4 max-w-md mx-auto text-lg text-gray-500 dark:text-gray-400">Fast, secure, and easy-to-use on any device.</p>
                    <div id="drop-zone" class="mt-8 drop-zone bg-white dark:bg-gray-800/50 rounded-lg cursor-pointer p-8 sm:p-12 md:p-16">
                        <input type="file" id="file-upload" class="drop-zone__input">
                        <span class="drop-zone__prompt">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                            <span class="mt-2 block font-semibold text-gray-900 dark:text-gray-100">Drag & drop or tap to upload</span>
                            <span class="mt-1 block text-sm text-gray-500 dark:text-gray-400">Supports JPG, PNG, PDF, and more</span>
                        </span>
                    </div>
                     <div id="file-details-section" class="hidden mt-6 text-left max-w-md mx-auto">
                        <p id="file-name" class="text-gray-600 dark:text-gray-300"></p>
                        <label for="format-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mt-4">Convert to:</label>
                        <select id="format-select" name="format" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option>pptx</option>
                            <option>excel</option>
                            <option>jpg</option>
                            <option>svg</option>
                            <option>pdf</option>
                        </select>
                        <button id="start-conversion-button" class="mt-6 w-full inline-flex items-center justify-center px-5 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">Start Conversion</button>
                    </div>
                    <p id="error-message" class="mt-4 text-red-500"></p>
                </section>

                <!-- Progress Section -->
                <section id="progress-section" class="hidden text-center">
                    <h2 id="progress-title" class="text-3xl font-bold text-gray-900 dark:text-white">Uploading...</h2>
                    <p id="progress-subtitle" class="mt-2 text-gray-500 dark:text-gray-400">Your file is being securely uploaded.</p>
                    <div class="mt-8">
                        <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
                        <p id="progress-text" class="mt-2 text-sm font-medium text-gray-900 dark:text-gray-200">0%</p>
                    </div>
                </section>

                <!-- Success Section -->
                <section id="success-section" class="hidden text-center">
                     <h2 class="text-3xl font-bold text-green-500">Conversion Successful!</h2>
                     <p class="mt-2 text-gray-500 dark:text-gray-400">Your file has been converted and is ready for download.</p>
                     <div class="mt-8 flex flex-col sm:flex-row sm:justify-center items-center gap-4">
                         <a id="download-link" href="#" download="converted-file" class="w-full sm:w-auto inline-flex items-center justify-center px-5 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">Download File</a>
                         <button id="convert-another-button" class="w-full sm:w-auto inline-flex items-center justify-center px-5 py-3 border border-gray-300 dark:border-gray-600 text-base font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">Convert Another File</button>
                     </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        // --- CONFIGURATION ---
        // 1. ENDPOINT FOR GETTING THE SIGNED UPLOAD URL (Step 1)
        const GET_UPLOAD_URL_API_ENDPOINT = 'https://get-upload-url-439192440179.europe-west1.run.app';
        // 2. ENDPOINT FOR CHECKING THE CONVERSION STATUS (Step 3 Polling)
        const CHECK_STATUS_API_ENDPOINT = 'https://filezila-check-status-439192440179.europe-west1.run.app';

        // --- DOM Elements ---
        const dropZone = document.getElementById('drop-zone');
        const fileUpload = document.getElementById('file-upload');
        const fileNameDisplay = document.getElementById('file-name');
        const errorMessage = document.getElementById('error-message');
        const uploaderSection = document.getElementById('uploader-section');
        const progressSection = document.getElementById('progress-section');
        const successSection = document.getElementById('success-section');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressTitle = document.getElementById('progress-title');
        const progressSubtitle = document.getElementById('progress-subtitle');
        const downloadLink = document.getElementById('download-link');
        const convertAnotherButton = document.getElementById('convert-another-button');
        const fileDetailsSection = document.getElementById('file-details-section');
        const startConversionButton = document.getElementById('start-conversion-button');

        let selectedFile = null;
        const POLLING_INTERVAL = 2000; // Check status every 2 seconds

        // --- Event Listeners ---
        dropZone.addEventListener('click', () => fileUpload.click());
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drop-zone--over'); });
        ['dragleave', 'dragend'].forEach(type => { dropZone.addEventListener(type, () => dropZone.classList.remove('drop-zone--over')); });
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            if (e.dataTransfer.files.length) {
                fileUpload.files = e.dataTransfer.files;
                handleFileSelect(fileUpload.files[0]);
            }
            dropZone.classList.remove('drop-zone--over');
        });
        fileUpload.addEventListener('change', e => { if (e.target.files.length) handleFileSelect(e.target.files[0]); });
        startConversionButton.addEventListener('click', () => {
             if (selectedFile) {
                uploadFile(selectedFile);
             }
        });
        convertAnotherButton.addEventListener('click', resetUI);

        // --- Core Logic ---
        function handleFileSelect(file) {
            if (!file) return;
            selectedFile = file;
            fileNameDisplay.textContent = `Selected file: ${file.name}`;
            errorMessage.textContent = '';
            dropZone.classList.add('hidden');
            fileDetailsSection.classList.remove('hidden');
        }

        async function uploadFile(file) {
            if (GET_UPLOAD_URL_API_ENDPOINT.includes('PASTE_YOUR')) {
                showError('Error: Backend API endpoint is not configured.');
                return;
            }
            
            try {
                // 1. Get a secure signed/presigned URL from our backend
                updateProgressUI(0, 'Preparing upload...');
                fileDetailsSection.classList.add('hidden');
                progressSection.classList.remove('hidden');

                const response = await fetch(GET_UPLOAD_URL_API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fileName: file.name, contentType: file.type }),
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('SERVER RESPONSE FAILED:', response.status, response.statusText, errorText);
                    let errorDetail = `Status ${response.status} (${response.statusText}).`;
                    throw new Error(`Could not get upload URL. ${errorDetail}`);
                }
                const { url } = await response.json();

                // 2. Upload the file directly to Cloud Storage using the secure URL
                updateProgressUI(25, 'Uploading file...');
                const uploadResponse = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': file.type },
                    body: file,
                });

                if (!uploadResponse.ok) {
                    const errorText = await uploadResponse.text();
                    console.error('GCS PUT UPLOAD FAILED:', uploadResponse.status, errorText);
                    throw new Error(`Direct file upload failed (Status ${uploadResponse.status}). Check permissions/CORS.`);
                }
                
                // 3. Start Polling for Conversion Status
                updateProgressUI(50, 'File uploaded. Starting conversion process...');
                startPolling(file.name);

            } catch (error) {
                console.error('Upload process failed:', error);
                showError(`Upload failed: ${error.message}`);
                resetUI();
            }
        }
        
        // --- NEW POLLING LOGIC ---
        function startPolling(originalName) {
            const selectedFormat = document.getElementById('format-select').value;
            const poll = setInterval(async () => {
                
                updateProgressUI(75, 'Waiting for conversion to complete...');

                try {
                    // CALLS YOUR LIVE STATUS CHECKER SERVICE
                    const response = await fetch(CHECK_STATUS_API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ originalName, targetFormat: selectedFormat }),
                    });
                    
                    if (!response.ok) {
                        clearInterval(poll);
                        throw new Error(`Status check failed: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    if (result.status === 'complete') {
                        // Conversion is done! Stop polling.
                        clearInterval(poll);
                        updateProgressUI(100, 'Complete!');
                        // Pass the real download link to showSuccess
                        showSuccess(result.downloadUrl, result.convertedFileName); 
                    } else if (result.status === 'processing') {
                         // Keep waiting
                         updateProgressUI(75, 'Conversion in progress...');
                    } else if (result.status === 'error') {
                        clearInterval(poll);
                        throw new Error(`Conversion error: ${result.message}`);
                    }
                } catch (error) {
                    clearInterval(poll);
                    console.error('Polling failed:', error);
                    showError(`Conversion failed: ${error.message}`);
                    resetUI();
                }
            }, POLLING_INTERVAL);
        }


        function updateProgressUI(percentage, text) {
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${percentage}%`;
            progressSubtitle.textContent = text;
        }

        // --- FINALIZED SHOW SUCCESS (Uses real URL) ---
        function showSuccess(downloadUrl, convertedFileName) {
            
            // The downloadUrl now comes from the checkStatus endpoint
            downloadLink.href = downloadUrl;
            downloadLink.download = convertedFileName; // Uses the filename returned by the API

            progressSection.classList.add('hidden');
            successSection.classList.remove('hidden');
        }

        function showError(message) {
            errorMessage.textContent = message;
            dropZone.classList.remove('hidden');
            fileDetailsSection.classList.add('hidden');
            progressSection.classList.add('hidden');
            successSection.classList.add('hidden');
        }

        function resetUI() {
            successSection.classList.add('hidden');
            dropZone.classList.remove('hidden');
            selectedFile = null;
            fileUpload.value = '';
            fileNameDisplay.textContent = '';
            errorMessage.textContent = '';
            updateProgressUI(0, '');
        }
    </script>
</body>
</html>
      
